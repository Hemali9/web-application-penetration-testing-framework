<!DOCTYPE html>
<html>
<head>
    <title>{{ tool | capitalize }} Output</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #output-box {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            height: 400px;
            overflow-y: scroll;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .btn-copy { margin-right: 10px; }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <h3>{{ tool | capitalize }} Scan Output</h3>

    <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-primary btn-copy" onclick="copyOutput()">ðŸ“‹ Copy</button>
        <a id="export-btn" class="btn btn-success" href="#" download="scan_output.txt">ðŸ’¾ Export TXT</a>
    </div>

    <div id="output-box"></div>

    <a href="{{ url_for('manual_testing', target_id=request.view_args['target_id']) }}" class="btn btn-secondary mt-3">Back</a>
</div>

<script>
    const outputBox = document.getElementById('output-box');
    const exportBtn = document.getElementById('export-btn');

   
    const eventSource = new EventSource("{{ url_for('run_tool', tool=tool, target_id=request.view_args['target_id']) }}");
    
   
    fetch("{{ url_for('run_tool', tool=tool, target_id=request.view_args['target_id']) }}")
        .then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) return;
                    outputBox.innerHTML += decoder.decode(value);
                    outputBox.scrollTop = outputBox.scrollHeight;
                    read();
                });
            }
            read();
        });

 
    function copyOutput() {
        navigator.clipboard.writeText(outputBox.innerText).then(() => {
            alert('Output copied to clipboard!');
        });
    }

   
    function updateExport() {
        const blob = new Blob([outputBox.innerText], { type: 'text/plain' });
        exportBtn.href = URL.createObjectURL(blob);
    }

    setInterval(updateExport, 1000);
</script>
</body>
</html>
